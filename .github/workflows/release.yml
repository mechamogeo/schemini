name: Release

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    # Only run if CI succeeded (or manual trigger)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write
      pull-requests: write
      packages: write # Required for GitHub Packages
      id-token: write # Required for npm provenance
      attestations: write # Required for GitHub attestations

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # For workflow_run, checkout the branch that triggered CI
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}
          fetch-depth: 0 # Full history for changelog generation

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm --filter "@schemini/*" build

      - name: Create Release Pull Request or Version Packages
        id: changesets
        uses: changesets/action@v1
        with:
          title: "chore: release packages"
          commit: "chore: release packages"
          # Don't publish here - we'll do it manually with provenance
          publish: echo "Skipping automatic publish"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Pack tarballs for attestation before publishing
      - name: Pack @schemini/core
        if: steps.changesets.outputs.hasChangesets == 'false'
        run: |
          cd packages/core
          npm pack
          mv *.tgz ../../schemini-core.tgz

      - name: Pack @schemini/locale
        if: steps.changesets.outputs.hasChangesets == 'false'
        run: |
          cd packages/locale
          npm pack
          mv *.tgz ../../schemini-locale.tgz

      # Generate GitHub attestations for the tarballs
      - name: Attest @schemini/core
        id: attest_core
        if: steps.changesets.outputs.hasChangesets == 'false'
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ./schemini-core.tgz

      - name: Attest @schemini/locale
        id: attest_locale
        if: steps.changesets.outputs.hasChangesets == 'false'
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: ./schemini-locale.tgz

      # Publish @schemini/core with provenance to npm
      - name: Publish @schemini/core to npm
        id: publish_core
        if: steps.changesets.outputs.hasChangesets == 'false'
        uses: JS-DevTools/npm-publish@v3
        with:
          token: ${{ secrets.NPM_TOKEN }}
          package: ./packages/core
          provenance: true
          access: public
          registry: https://registry.npmjs.org

      # Publish @schemini/locale with provenance to npm
      - name: Publish @schemini/locale to npm
        id: publish_locale
        if: steps.changesets.outputs.hasChangesets == 'false'
        uses: JS-DevTools/npm-publish@v3
        with:
          token: ${{ secrets.NPM_TOKEN }}
          package: ./packages/locale
          provenance: true
          access: public
          registry: https://registry.npmjs.org

      # Note: GitHub Packages publishing is disabled because the package scope
      # (@schemini) doesn't match the GitHub owner (mechamogeo). To enable GitHub
      # Packages, either create a GitHub org named "schemini" or rename packages
      # to @mechamogeo/core and @mechamogeo/locale.

      # Create GitHub Release for @schemini/core
      - name: Create GitHub Release for @schemini/core
        if: steps.publish_core.outputs.type
        run: |
          VERSION="${{ steps.publish_core.outputs.version }}"
          TAG="@schemini/core@${VERSION}"

          # Generate changelog
          last_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$last_tag" ]; then
            changelog=$(git log --pretty=format:"- %s (%h)" ${last_tag}..HEAD --no-merges | head -20)
          else
            changelog=$(git log --pretty=format:"- %s (%h)" --no-merges | head -20)
          fi

          # Rename tarball for release
          TARBALL="schemini-core-${VERSION}.tgz"
          cp schemini-core.tgz "$TARBALL"

          # Create release with tarball
          gh release create "$TAG" \
            --title "$TAG" \
            --notes "## What's Changed

          ${changelog}

          ## Verification

          This release includes npm provenance attestations and GitHub attestations.
          - [View attestations](https://github.com/${{ github.repository }}/attestations)
          - [npm package](https://www.npmjs.com/package/@schemini/core/v/${VERSION})

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${last_tag}...${TAG}" \
            --target ${{ github.sha }} \
            "$TARBALL" || echo "Release may already exist"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Create GitHub Release for @schemini/locale
      - name: Create GitHub Release for @schemini/locale
        if: steps.publish_locale.outputs.type
        run: |
          VERSION="${{ steps.publish_locale.outputs.version }}"
          TAG="@schemini/locale@${VERSION}"

          # Rename tarball for release
          TARBALL="schemini-locale-${VERSION}.tgz"
          cp schemini-locale.tgz "$TARBALL"

          # Create release with tarball
          gh release create "$TAG" \
            --title "$TAG" \
            --notes "## @schemini/locale v${VERSION}

          Released alongside @schemini/core.

          ## Verification

          This release includes npm provenance attestations and GitHub attestations.
          - [View attestations](https://github.com/${{ github.repository }}/attestations)
          - [npm package](https://www.npmjs.com/package/@schemini/locale/v/${VERSION})
          " \
            --target ${{ github.sha }} \
            "$TARBALL" || echo "Release may already exist"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: steps.publish_core.outputs.type || steps.publish_locale.outputs.type
        run: |
          echo "## Published Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.publish_core.outputs.type }}" ]; then
            echo "- @schemini/core@${{ steps.publish_core.outputs.version }} (${{ steps.publish_core.outputs.type }})" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${{ steps.publish_locale.outputs.type }}" ]; then
            echo "- @schemini/locale@${{ steps.publish_locale.outputs.version }} (${{ steps.publish_locale.outputs.type }})" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All packages published to npm with provenance enabled." >> $GITHUB_STEP_SUMMARY
